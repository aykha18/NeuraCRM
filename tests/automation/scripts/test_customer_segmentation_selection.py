#!/usr/bin/env python3
"""
Customer Segmentation Selection Test
Tests selecting segments and viewing their details
"""

from playwright.sync_api import sync_playwright
import time

def test_customer_segmentation_selection():
    """Test selecting customer segments and viewing details"""
    
    print("üë• Testing Customer Segmentation Selection")
    print("=" * 50)
    
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=False, slow_mo=1000)
        context = browser.new_context(viewport={"width": 1920, "height": 1080})
        page = context.new_page()
        
        try:
            # Login
            print("üîê Logging in...")
            page.goto("http://127.0.0.1:8000/signin")
            page.wait_for_load_state("networkidle")
            
            page.fill('input[type="email"]', "nodeit@node.com")
            page.fill('input[type="password"]', "NodeIT2024!")
            page.click('button[type="submit"]')
            page.wait_for_url("**/dashboard", timeout=10000)
            print("‚úÖ Login successful")
            
            # Navigate to customer segmentation
            print("\nüë• Navigating to Customer Segmentation page...")
            page.goto("http://127.0.0.1:8000/customer-segmentation")
            page.wait_for_load_state("networkidle")
            time.sleep(3)  # Wait for data to load
            print("‚úÖ Navigated to customer segmentation page")
            
            # Check for segments
            print("\nüë• Checking for customer segments...")
            segments = page.locator('.space-y-4 > div')
            segment_count = segments.count()
            if segment_count > 0:
                print(f"‚úÖ Found {segment_count} customer segments")
                
                # Test selecting the first segment
                print("\nüéØ Testing segment selection...")
                first_segment = segments.first
                if first_segment.is_visible():
                    first_segment.click()
                    time.sleep(2)  # Wait for details to load
                    print("‚úÖ Clicked on first segment")
                    
                    # Check if segment is selected (highlighted)
                    class_attr = first_segment.get_attribute('class')
                    if 'border-purple-500' in class_attr or 'bg-purple-50' in class_attr:
                        print("‚úÖ Segment is highlighted/selected")
                    else:
                        print("‚ö†Ô∏è Segment may not be properly selected")
                    
                    # Check segment details panel
                    print("\nüìã Checking segment details panel...")
                    
                    # Check for segment overview section
                    overview_section = page.locator('h3:has-text("Segment Overview")')
                    if overview_section.is_visible():
                        print("‚úÖ Segment Overview section found")
                        
                        # Check for risk score
                        risk_score = page.locator('text="Risk Score"')
                        if risk_score.is_visible():
                            print("  ‚úÖ Risk Score found")
                        else:
                            print("  ‚ùå Risk Score not found")
                        
                        # Check for opportunity score
                        opportunity_score = page.locator('text="Opportunity Score"')
                        if opportunity_score.is_visible():
                            print("  ‚úÖ Opportunity Score found")
                        else:
                            print("  ‚ùå Opportunity Score not found")
                        
                        # Check for last updated
                        last_updated = page.locator('text="Last Updated"')
                        if last_updated.is_visible():
                            print("  ‚úÖ Last Updated found")
                        else:
                            print("  ‚ùå Last Updated not found")
                    else:
                        print("‚ùå Segment Overview section not found")
                    
                    # Check for AI insights section
                    print("\nüß† Checking AI insights section...")
                    ai_insights = page.locator('h3:has-text("AI Insights")')
                    if ai_insights.is_visible():
                        print("‚úÖ AI Insights section found")
                        
                        # Check for key characteristics
                        key_char = page.locator('text="Key Characteristics"')
                        if key_char.is_visible():
                            print("  ‚úÖ Key Characteristics found")
                        else:
                            print("  ‚ùå Key Characteristics not found")
                        
                        # Check for performance summary
                        perf_summary = page.locator('text="Performance Summary"')
                        if perf_summary.is_visible():
                            print("  ‚úÖ Performance Summary found")
                        else:
                            print("  ‚ùå Performance Summary not found")
                        
                        # Check for trends
                        trends = page.locator('text="Trends"')
                        if trends.is_visible():
                            print("  ‚úÖ Trends found")
                        else:
                            print("  ‚ùå Trends not found")
                    else:
                        print("‚ö†Ô∏è AI Insights section not found (may not have insights)")
                    
                    # Check for recommendations section
                    print("\nüí° Checking recommendations section...")
                    recommendations = page.locator('h3:has-text("Recommendations")')
                    if recommendations.is_visible():
                        print("‚úÖ Recommendations section found")
                        
                        # Check for recommendation items
                        rec_items = page.locator('.space-y-2 > li')
                        rec_count = rec_items.count()
                        if rec_count > 0:
                            print(f"  ‚úÖ Found {rec_count} recommendations")
                        else:
                            print("  ‚ùå No recommendations found")
                    else:
                        print("‚ö†Ô∏è Recommendations section not found (may not have recommendations)")
                    
                    # Check for segment members section
                    print("\nüë• Checking segment members section...")
                    members_section = page.locator('h3:has-text("Segment Members")')
                    if members_section.is_visible():
                        print("‚úÖ Segment Members section found")
                        
                        # Check for member count in header
                        member_count = page.locator('text=/Segment Members \\(\\d+\\)/')
                        if member_count.is_visible():
                            count_text = member_count.text_content()
                            print(f"  ‚úÖ Member count found: {count_text}")
                        else:
                            print("  ‚ùå Member count not found")
                        
                        # Check for member items
                        member_items = page.locator('.space-y-3 > div')
                        member_item_count = member_items.count()
                        if member_item_count > 0:
                            print(f"  ‚úÖ Found {member_item_count} member items")
                            
                            # Check first member for required info
                            first_member = member_items.first
                            if first_member.is_visible():
                                # Check for contact name
                                contact_name = first_member.locator('.font-medium')
                                if contact_name.is_visible():
                                    name_text = contact_name.text_content()
                                    print(f"    ‚úÖ Contact name: {name_text}")
                                else:
                                    print("    ‚ùå Contact name not found")
                                
                                # Check for company
                                company = first_member.locator('.text-sm.text-gray-600')
                                if company.is_visible():
                                    print("    ‚úÖ Company found")
                                else:
                                    print("    ‚ùå Company not found")
                                
                                # Check for email
                                email = first_member.locator('.text-xs.text-gray-500')
                                if email.is_visible():
                                    print("    ‚úÖ Email found")
                                else:
                                    print("    ‚ùå Email not found")
                                
                                # Check for membership score
                                membership_score = first_member.locator('.text-sm.font-medium')
                                if membership_score.is_visible():
                                    score_text = membership_score.text_content()
                                    print(f"    ‚úÖ Membership score: {score_text}")
                                else:
                                    print("    ‚ùå Membership score not found")
                        else:
                            print("  ‚ùå No member items found")
                    else:
                        print("‚ùå Segment Members section not found")
                    
                    # Test selecting another segment
                    print("\nüîÑ Testing selection of another segment...")
                    if segment_count > 1:
                        second_segment = segments.nth(1)
                        if second_segment.is_visible():
                            second_segment.click()
                            time.sleep(2)
                            print("‚úÖ Clicked on second segment")
                            
                            # Check if details updated
                            new_overview = page.locator('h3:has-text("Segment Overview")')
                            if new_overview.is_visible():
                                print("‚úÖ Segment details updated for second segment")
                            else:
                                print("‚ùå Segment details not updated")
                        else:
                            print("‚ùå Second segment not visible")
                    else:
                        print("‚ö†Ô∏è Only one segment available, cannot test selection switching")
                    
                else:
                    print("‚ùå First segment not visible")
                    return False
            else:
                print("‚ùå No customer segments found")
                return False
            
            # Take a screenshot
            print("\nüì∏ Taking screenshot...")
            page.screenshot(path="test-results/customer_segmentation_selection.png")
            print("‚úÖ Screenshot saved as customer_segmentation_selection.png")
            
            print("\nüéâ Customer Segmentation selection test completed!")
            return True
            
        except Exception as e:
            print(f"‚ùå Error during test: {e}")
            return False
            
        finally:
            browser.close()

if __name__ == "__main__":
    success = test_customer_segmentation_selection()
    if success:
        print("\n‚úÖ Customer Segmentation selection test passed!")
    else:
        print("\n‚ùå Customer Segmentation selection test failed.")

